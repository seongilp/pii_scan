{% extends 'scanner_frontend/base.html' %}

{% block title %}스캔 결과 - 개인정보 스캐너{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">스캔 결과</h1>
        
        {% if error_message %}
        <div class="alert alert-danger">
            {{ error_message }}
        </div>
        {% endif %}
        
        {% if job %}
        <!-- Job Information -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">작업 정보</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>작업 ID:</strong> {{ job.job_id }}</p>
                        <p><strong>스캔 이름:</strong> {{ job.scan_name }}</p>
                        <p><strong>상태:</strong> 
                            {% if job.status == 'pending' %}
                            <span class="badge bg-secondary">대기 중</span>
                            {% elif job.status == 'running' %}
                            <span class="badge bg-warning">실행 중</span>
                            {% elif job.status == 'completed' %}
                            <span class="badge bg-success">완료</span>
                            {% elif job.status == 'failed' %}
                            <span class="badge bg-danger">실패</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>데이터베이스 유형:</strong> {{ job.db_type }}</p>
                        <p><strong>호스트:</strong> {{ job.host }}</p>
                        <p><strong>데이터베이스:</strong> {{ job.database }}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>생성 시간:</strong> {{ job.created_at }}</p>
                        <p><strong>시작 시간:</strong> {{ job.started_at }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>완료 시간:</strong> {{ job.completed_at }}</p>
                        <p><strong>진행률:</strong> {{ job.progress }}%</p>
                    </div>
                </div>
                
                {% if job.status == 'running' %}
                <div class="alert alert-info">
                    <strong>현재 단계:</strong> {{ job.current_step }}
                    <p>스캔이 진행 중입니다. 이 페이지는 10초마다 자동으로 새로고침됩니다.</p>
                </div>
                {% elif job.status == 'failed' %}
                <div class="alert alert-danger">
                    <strong>오류:</strong> {{ job.error_message }}
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if job.status == 'completed' and results %}
        <!-- Results Tabs -->
        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">요약</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="structure-tab" data-bs-toggle="tab" data-bs-target="#structure" type="button" role="tab">구조 분석</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="privacy-tab" data-bs-toggle="tab" data-bs-target="#privacy" type="button" role="tab">개인정보 스캔</button>
            </li>
        </ul>
        
        <div class="tab-content mt-3" id="resultTabsContent">
            <!-- Summary Tab -->
            <div class="tab-pane fade show active" id="summary" role="tabpanel">
                {% if summary %}
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">Executive Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>데이터베이스 통계</h6>
                                <ul class="list-group mb-4">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        전체 데이터베이스
                                        <span class="badge bg-primary rounded-pill">{{ summary.total_databases }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        전체 테이블
                                        <span class="badge bg-primary rounded-pill">{{ summary.total_tables }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        전체 컬럼
                                        <span class="badge bg-primary rounded-pill">{{ summary.total_columns }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        전체 데이터 행
                                        <span class="badge bg-primary rounded-pill">{{ summary.total_data_rows }}</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>위험 수준별 테이블</h6>
                                <ul class="list-group mb-4">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        높은 위험 테이블
                                        <span class="badge bg-danger rounded-pill">{{ summary.high_risk_tables }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        중간 위험 테이블
                                        <span class="badge bg-warning rounded-pill">{{ summary.medium_risk_tables }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        낮은 위험 테이블
                                        <span class="badge bg-success rounded-pill">{{ summary.low_risk_tables }}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <h6>발견된 개인정보 패턴</h6>
                        <ul class="list-group mb-4">
                            {% for pattern, count in summary.privacy_patterns_found.items %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ pattern }}
                                <span class="badge bg-info rounded-pill">{{ count }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        
                        <h6>상위 위험 테이블</h6>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>테이블</th>
                                        <th>위험 수준</th>
                                        <th>개인정보 점수</th>
                                        <th>발견된 패턴</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for table in summary.top_risk_tables %}
                                    <tr>
                                        <td>{{ table.table }}</td>
                                        <td>
                                            {% if table.risk_level == 'HIGH' %}
                                            <span class="badge bg-danger">높음</span>
                                            {% elif table.risk_level == 'MEDIUM' %}
                                            <span class="badge bg-warning">중간</span>
                                            {% elif table.risk_level == 'LOW' %}
                                            <span class="badge bg-success">낮음</span>
                                            {% else %}
                                            <span class="badge bg-secondary">{{ table.risk_level }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ table.privacy_score }}</td>
                                        <td>{{ table.patterns|join:", " }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    요약 정보를 찾을 수 없습니다.
                </div>
                {% endif %}
            </div>
            
            <!-- Structure Analysis Tab -->
            <div class="tab-pane fade" id="structure" role="tabpanel">
                {% if results.structure_analysis %}
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">데이터베이스 구조 분석</h5>
                    </div>
                    <div class="card-body">
                        <pre class="bg-light p-3">{{ results.structure_analysis }}</pre>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    구조 분석 결과를 찾을 수 없습니다.
                </div>
                {% endif %}
            </div>
            
            <!-- Privacy Scan Tab -->
            <div class="tab-pane fade" id="privacy" role="tabpanel">
                {% if results.privacy_scan_results %}
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        <h5 class="card-title mb-0">개인정보 스캔 결과</h5>
                    </div>
                    <div class="card-body">
                        <pre class="bg-light p-3">{{ results.privacy_scan_results }}</pre>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    개인정보 스캔 결과를 찾을 수 없습니다.
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Download Options -->
        <div class="card mt-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">결과 다운로드</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <a href="/api/results/{{ job.job_id }}/download?format=json" class="btn btn-primary w-100 mb-2">JSON 형식으로 다운로드</a>
                    </div>
                    <div class="col-md-6">
                        <a href="/api/results/{{ job.job_id }}/download?format=txt" class="btn btn-secondary w-100 mb-2">텍스트 형식으로 다운로드</a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div class="alert alert-warning">
            작업 정보를 찾을 수 없습니다.
        </div>
        {% endif %}
        
        <div class="mt-4">
            <a href="{% url 'scan_jobs' %}" class="btn btn-primary">스캔 작업 목록으로 돌아가기</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh the page every 10 seconds
    setTimeout(function() {
        location.reload();
    }, 10000);
</script>
{% endblock %}